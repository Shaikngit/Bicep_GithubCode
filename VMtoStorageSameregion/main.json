{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "5780502544041646476"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location of the resource group"
      }
    },
    "adminpassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin Password for the VMs and SQL Server"
      }
    },
    "adminusername": {
      "type": "string"
    },
    "vmSizeOption": {
      "type": "string",
      "allowedValues": [
        "Overlake",
        "Non-Overlake"
      ],
      "metadata": {
        "description": "Specifies whether to use Overlake VM size or not."
      }
    },
    "useCustomImage": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Specifies whether to use a custom image or a default image. Select \"Yes\" for custom image, \"No\" for default image."
      }
    }
  },
  "variables": {
    "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
  },
  "resources": [
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, 'vm-storage-blob-contributor')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'windowsVMDeployment'), '2025-04-01').outputs.vmPrincipalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'windowsVMDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "windowsVMDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminusername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminpassword')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "useCustomImage": {
            "value": "[parameters('useCustomImage')]"
          },
          "vmSizeOption": {
            "value": "[parameters('vmSizeOption')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13262298776977465499"
            }
          },
          "parameters": {
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "The username for the virtual machine administrator."
              }
            },
            "adminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The password for the virtual machine administrator."
              }
            },
            "vmSizeOption": {
              "type": "string",
              "allowedValues": [
                "Overlake",
                "Non-Overlake"
              ],
              "metadata": {
                "description": "Specifies whether to use Overlake VM size or not."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the resource group."
              }
            },
            "useCustomImage": {
              "type": "string",
              "defaultValue": "No",
              "allowedValues": [
                "Yes",
                "No"
              ],
              "metadata": {
                "description": "Specifies whether to use a custom image or a default image."
              }
            },
            "customImageResourceId": {
              "type": "string",
              "defaultValue": "/subscriptions/8f8bee69-0b24-457d-a9af-3623095b0d78/resourceGroups/shaiknlab2/providers/Microsoft.Compute/galleries/shaikngallery/images/newvmdef/versions/0.0.1",
              "metadata": {
                "description": "The resource ID of the custom image to use if useCustomImage is true."
              }
            }
          },
          "variables": {
            "useCustomImageBool": "[if(equals(parameters('useCustomImage'), 'Yes'), true(), false())]",
            "vmSize": "[if(equals(parameters('vmSizeOption'), 'Overlake'), 'Standard_D2s_v5', 'Standard_D2s_v4')]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-11-01",
              "name": "clientVNET",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.0.0.0/16"
                  ]
                },
                "subnets": [
                  {
                    "name": "default",
                    "properties": {
                      "addressPrefix": "10.0.0.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'myNsg')]"
                      }
                    }
                  },
                  {
                    "name": "AzureBastionSubnet",
                    "properties": {
                      "addressPrefix": "10.0.1.0/26"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', 'myNsg')]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "myNsg",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": []
              }
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "bastion-pip",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "vm-pip",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/bastionHosts",
              "apiVersion": "2023-11-01",
              "name": "myBastion",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "bastionIpConfig",
                    "properties": {
                      "subnet": {
                        "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', 'clientVNET'), '2023-11-01').subnets[1].id]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'bastion-pip')]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', 'bastion-pip')]",
                "[resourceId('Microsoft.Network/virtualNetworks', 'clientVNET')]"
              ]
            },
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-11-01",
              "name": "myNic",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', 'clientVNET'), '2023-11-01').subnets[0].id]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'vm-pip')]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', 'vm-pip')]",
                "[resourceId('Microsoft.Network/virtualNetworks', 'clientVNET')]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-09-01",
              "name": "myVm",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[variables('vmSize')]"
                },
                "osProfile": {
                  "computerName": "myVm",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]"
                },
                "storageProfile": {
                  "imageReference": "[if(variables('useCustomImageBool'), createObject('id', parameters('customImageResourceId')), createObject('publisher', 'MicrosoftWindowsServer', 'offer', 'WindowsServer', 'sku', '2019-Datacenter', 'version', 'latest'))]",
                  "osDisk": {
                    "createOption": "FromImage"
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', 'myNic')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', 'myNic')]"
              ]
            }
          ],
          "outputs": {
            "bastionName": {
              "type": "string",
              "value": "myBastion"
            },
            "vmName": {
              "type": "string",
              "value": "myVm"
            },
            "vmPrivateIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', 'myNic'), '2023-11-01').ipConfigurations[0].properties.privateIPAddress]"
            },
            "vmPublicIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', 'vm-pip'), '2023-11-01').ipAddress]"
            },
            "vmPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', 'myVm'), '2023-09-01', 'full').identity.principalId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storageAccountDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "61697488184909447"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "defaultValue": "[format('shaiknstr{0}', uniqueString(resourceGroup().id))]",
              "metadata": {
                "description": "Specifies the name of the Azure Storage account."
              }
            },
            "containerName": {
              "type": "string",
              "defaultValue": "folder",
              "metadata": {
                "description": "Specifies the name of the blob container."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Specifies the location in which the Azure Storage resources should be deployed."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('containerName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountBlobEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
            },
            "containerName": {
              "type": "string",
              "value": "[parameters('containerName')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "bastionName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'windowsVMDeployment'), '2025-04-01').outputs.bastionName.value]"
    },
    "vmName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'windowsVMDeployment'), '2025-04-01').outputs.vmName.value]"
    },
    "vmPrivateIp": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'windowsVMDeployment'), '2025-04-01').outputs.vmPrivateIp.value]"
    },
    "vmPublicIp": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'windowsVMDeployment'), '2025-04-01').outputs.vmPublicIp.value]"
    },
    "vmPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'windowsVMDeployment'), '2025-04-01').outputs.vmPrincipalId.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDeployment'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "storageBlobEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDeployment'), '2025-04-01').outputs.storageAccountBlobEndpoint.value]"
    },
    "containerName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDeployment'), '2025-04-01').outputs.containerName.value]"
    },
    "roleAssignmentInfo": {
      "type": "string",
      "value": "VM has Storage Blob Data Contributor role on storage account"
    }
  }
}